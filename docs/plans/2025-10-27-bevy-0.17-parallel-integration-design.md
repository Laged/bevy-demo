# Bevy 0.17 Features: Parallel Agent Integration Design

**Date**: 2025-10-27
**Status**: Design Approved
**Approach**: Domain-Centric Parallelization

## Overview

This design organizes Bevy 0.17 feature integration across multiple agents working in parallel, respecting domain boundaries established in the parallel agent architecture. Each agent owns complete features within their domain, coordinating via shared event contracts.

## Goals

- **Maximize parallel agent utilization** across UI, Gameplay, and Graphics domains
- **Leverage headless testing infrastructure** for autonomous verification
- **Maintain domain boundaries** per ARCHITECTURE.md rules
- **Ensure performance baseline** (â‰¥15k fps) throughout integration

## Agent Assignments

### UI Agent (Primary Workload - 3 Phases)

**Phase 2: Headless Widgets Integration**
- Branch: `bevy-0.17-features/ui-widgets`
- Deliverables:
  - Pause menu with Button widgets
  - Settings panel with Sliders
  - Wave selector stub (RadioButton/Checkbox)
  - Visual styling for standard mode
  - Headless tests for all interactions

**Phase 3: ViewportNode Integration**
- Branch: `bevy-0.17-features/ui-viewport`
- Deliverables:
  - Minimap camera system tracking player
  - Minimap UI node rendering via ViewportNode
  - Wave preview panel showing spawn positions
  - Headless tests for camera setup

**Phase 6: UI Polish**
- Branch: `bevy-0.17-features/ui-polish`
- Deliverables:
  - Gradient backgrounds for health bars
  - Val helper functions throughout layout code
  - Text shadows for score/damage numbers
  - Responsive UI verification

### Gameplay Agent (Foundation - 1 Phase)

**Phase 5: Event System Modernization**
- Branch: `bevy-0.17-features/gameplay-events`
- Deliverables:
  - Refactor collision events to Trigger pattern
  - Replace EventReader loops with Trigger observers
  - Component lifecycle events (On::<Add>, On::<Remove>)
  - Modernize health/damage event handling
  - Headless tests for observer behavior

### Graphics Agent (Rendering Layer - 1 Phase)

**Phase 4: Tilemap Expansion**
- Branch: `bevy-0.17-features/graphics-tilemap`
- Deliverables:
  - Arena tilemap background using TilemapChunk
  - Multiple colored arena zones (safe/danger/neutral)
  - Visual distinction via tinting and tile patterns
  - Performance benchmarks via headless tests

### Testing Agent (Cross-Cutting Support)

**Continuous Responsibilities**:
- Monitor performance across all feature branches
- Run headless tests on each commit
- Report regressions (fps < 15k threshold)
- Verify integration before merges

## Event Contracts

All events defined in `src/core/events.rs` before agent work begins. Events are read-only contracts - no modifications once work starts.

### UI Domain Events

```rust
#[derive(Event)]
pub struct PauseMenuToggled;

#[derive(Event)]
pub struct SettingsChanged {
    pub volume: f32,
    pub difficulty: f32,
    pub particle_count: u32,
}

#[derive(Event)]
pub struct MinimapCameraReady {
    pub camera_entity: Entity,
}
```

### Gameplay Domain Events (Modernized)

```rust
#[derive(Event)]
pub struct EnemySpawned {
    pub enemy_entity: Entity,
    pub enemy_type: EnemyType,
}

#[derive(Event)]
pub struct BulletHit {
    pub bullet_entity: Entity,
    pub target_entity: Entity,
    pub damage: f32,
}

#[derive(Event)]
pub struct PlayerDamaged {
    pub damage: f32,
    pub source_entity: Option<Entity>,
}
```

### Graphics Domain Events

```rust
#[derive(Event)]
pub struct TilemapChunkLoaded {
    pub chunk_entity: Entity,
}

#[derive(Event)]
pub struct TileDamaged {
    pub chunk_entity: Entity,
    pub tile_index: usize,
}
```

### Event Contract Rules

1. All events defined in `src/core/events.rs` before agent work begins
2. Events are read-only contracts - no modifications once work starts
3. Agents communicate via events only - no direct cross-domain calls
4. Testing Agent verifies event behavior with headless tests

## Development Workflow

### Pre-Work Setup

1. **Define event contracts** in `src/core/events.rs`
2. **Create feature branches** from `bevy-0.17-features`:
   - `ui-widgets`
   - `ui-viewport`
   - `ui-polish`
   - `gameplay-events`
   - `graphics-tilemap`
3. **Assign agents** to branches with clear ownership

### Work Phase (Parallel Execution)

All agents work simultaneously with these rules:
- Each agent owns their domain files exclusively
- Cross-domain communication via events only
- Commit frequently to feature branch
- Run headless tests before each commit
- Report progress and blockers

### Integration & Merge Strategy

**Merge order** (to minimize conflicts):

1. **First**: `gameplay-events` branch
   - Provides foundation for event-based communication
   - Other agents may need to rebase if events change

2. **Second**: `ui-widgets` branch
   - Introduces new UI components other phases build on
   - Pause menu needed before polish phase

3. **Third**: `ui-viewport` and `graphics-tilemap` branches (parallel merge)
   - Independent features, no conflicts expected
   - Can merge in either order

4. **Last**: `ui-polish` branch
   - Refinement layer, depends on widgets and viewport

### Conflict Resolution

- **Event contract conflicts**: Gameplay Agent arbitrates (owns `core/events.rs`)
- **UI conflicts**: UI Agent resolves (owns UI domain)
- **Cross-domain conflicts**: Refer to ARCHITECTURE.md rules

## Detailed Agent Work Breakdown

### UI Agent - Phase 2: Headless Widgets

**Key Files**:
- `src/domains/ui/pause_menu.rs` (new)
- `src/domains/ui/settings_panel.rs` (new)
- `src/domains/ui/mod.rs` (update exports)
- `src/domains/ui/README.md` (update responsibilities)
- `tests/ui_widgets_test.rs` (new - headless tests)

**Success Criteria**:
- All widgets work in headless mode (verified by tests)
- Pause menu transitions GameState correctly
- Settings sliders trigger SettingsChanged events
- Performance baseline maintained (â‰¥15k fps)

### UI Agent - Phase 3: ViewportNode

**Key Files**:
- `src/domains/ui/minimap.rs` (new)
- `src/domains/ui/wave_preview.rs` (new)
- `src/domains/ui/hud.rs` (integrate minimap into HUD)
- `tests/viewport_test.rs` (new - headless tests)

**Success Criteria**:
- Minimap camera tracks player correctly
- ViewportNode renders without errors
- Camera logic testable in headless mode
- No performance regression

### UI Agent - Phase 6: UI Polish

**Key Files**:
- `src/domains/ui/hud.rs` (refactor with gradients and Val helpers)
- `src/domains/ui/pause_menu.rs` (polish styling)
- `src/domains/ui/settings_panel.rs` (polish styling)

**Success Criteria**:
- All `Val::Px()` replaced with `px()` helpers
- Health bars use gradient backgrounds
- UI renders correctly at different window sizes

### Gameplay Agent - Phase 5: Event System

**Key Files**:
- `src/core/collision.rs` (refactor to Trigger pattern)
- `src/entities/player.rs` (use observers for damage)
- `src/entities/enemy.rs` (use observers for spawn/death)
- `src/domains/gameplay/combat.rs` (refactor bullet collision)
- `tests/event_system_test.rs` (new - verify observer behavior)

**Success Criteria**:
- All `EventReader<T>` replaced with `Trigger<T>` observers
- Component lifecycle events (On::<Add>, On::<Remove>) implemented
- Headless tests verify event flow
- Performance maintained or improved

### Graphics Agent - Phase 4: Tilemap

**Key Files**:
- `src/domains/graphics/tilemap.rs` (new)
- `src/entities/world.rs` (integrate tilemap with world setup)
- `tests/tilemap_test.rs` (new - performance benchmarks)

**Success Criteria**:
- TilemapChunk rendering works in standard mode
- Tile logic (placement, tinting) testable in headless
- Performance impact measured (must stay â‰¥15k fps)
- Clear visual distinction between arena zones
- Integration with existing world decorations

## Testing Strategy

### Testing Agent Verification Checklist

Before merge approval for any branch:

```bash
cargo test -- --nocapture
cargo check
cargo build
cargo run  # Visual verification in standard mode

# Check performance baseline
cargo test test_headless_app_creation -- --nocapture
# Verify: fps â‰¥ 15,000, frame time â‰¤ 67Âµs
```

### Agent-Specific Test Requirements

**UI Agent** (Phases 2, 3, 6):
- Headless tests for all widget interactions (button press, slider change)
- Camera positioning tests for minimap/viewport
- No visual rendering tests needed (standard mode manual verification)

**Gameplay Agent** (Phase 5):
- Observer trigger tests (verify events fire correctly)
- Component lifecycle tests (On::<Add>, On::<Remove>)
- Collision event refactor tests (compare old vs new behavior)

**Graphics Agent** (Phase 4):
- Tilemap chunk creation tests (headless)
- Performance benchmarks with multiple chunks
- Zone boundary tests (verify tile positions)

## Success Criteria

### Per-Branch Definition of Done

Before merging any feature branch to `bevy-0.17-features`:

âœ… **Code Quality**:
- All files have domain ownership headers
- Domain README updated with new modules
- No compiler warnings or errors
- Code follows existing patterns

âœ… **Testing**:
- All headless tests passing
- Performance baseline maintained (â‰¥15k fps)
- No regressions in existing tests
- Manual visual verification in standard mode

âœ… **Documentation**:
- Code comments explain Bevy 0.17 APIs used
- README.md references new features if user-facing
- ARCHITECTURE.md updated if new patterns introduced

âœ… **Integration**:
- Branch rebased on latest `bevy-0.17-features`
- No merge conflicts
- Events used correctly per contract

### Overall Project Success Criteria

When all branches merged to `bevy-0.17-features`:

ðŸŽ¯ **Functionality**:
- Pause menu works (widgets + state transitions)
- Settings panel adjusts game parameters
- Minimap shows real-time arena overview
- Arena zones visually distinct (tilemap)
- All events use modern Trigger pattern
- UI polish applied (gradients, Val helpers, text shadows)

ðŸŽ¯ **Performance**:
- Maintains â‰¥15k fps baseline in headless tests
- No frame time regressions
- Visual mode runs smoothly at 60 fps

ðŸŽ¯ **Architecture**:
- Domain boundaries respected
- All cross-domain communication via events
- Backward compatibility maintained
- No violations of ARCHITECTURE.md rules

## References

- **Feature Documentation**: `docs/bevy-features-0.17.md`
- **Architecture Guide**: `docs/ARCHITECTURE.md`
- **Testing Infrastructure**: `src/domains/testing/`
- **Event Contracts**: `src/core/events.rs`

## Timeline Estimate

**Pre-Work**: 1-2 hours (event contract definition, branch setup)

**Parallel Work Phase**: Variable (agents work independently)
- Phase 2 (Headless Widgets): 4-6 hours
- Phase 3 (ViewportNode): 3-4 hours
- Phase 4 (Tilemap): 3-5 hours
- Phase 5 (Event System): 4-6 hours
- Phase 6 (UI Polish): 2-3 hours

**Integration Phase**: 2-3 hours (merging + conflict resolution)

**Total Elapsed Time** (with parallelization): ~10-15 hours
**Total Effort** (serial equivalent): ~18-26 hours

## Next Steps

1. Create event contracts in `src/core/events.rs`
2. Create feature branches from `bevy-0.17-features`
3. Launch agents in parallel with assigned branches
4. Testing Agent monitors all branches continuously
5. Merge branches in prescribed order
6. Final integration testing and merge to `dev`
